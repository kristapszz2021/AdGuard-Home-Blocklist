// ==UserScript==
// @name         Nuclear AI Adblocker + Network Kill
// @namespace    http://example.com
// @version      2026.2
// @description  Ultra-aggressive adblocker with Ollama AI dynamic detection and network/scriptlet blocking
// @match        *://*/*
// @run-at       document-start
// @grant        none
// ==/UserScript==

(function() {
    'use strict';

    // ============================
    // 1️⃣ Network-level / Scriptlet blocking
    // ============================
    const noopFunc = () => {};
    try { navigator.sendBeacon = undefined; } catch {}
    try { window.fetch = undefined; } catch {}
    try { XMLHttpRequest.prototype.send = noopFunc; } catch {}
    try { Object.defineProperty(window, 'ads', {get: noopFunc}); } catch {}
    try { Object.defineProperty(window, 'adblock', {get: noopFunc}); } catch {}
    try { Object.defineProperty(window, 'sponsored', {get: noopFunc}); } catch {}
    try { Object.defineProperty(window, 'tracking', {get: noopFunc}); } catch {}
    try { Object.defineProperty(window, 'analytics', {get: noopFunc}); } catch {}

    // Optional: block known ad domains preemptively
    const blockedDomains = [
        "doubleclick.net","googlesyndication.com","adservice.google.com",
        "pagead2.googlesyndication.com","ads.twitter.com","ads.facebook.com",
        "partner.googleadservices.com","adroll.com","taboola.com",
        "outbrain.com","mgid.com","revcontent.com",
        "tracking.","analytics.","pixel.","ads.",
        "platform.twitter.com","platform.instagram.com",
        "platform.facebook.com","platform.tiktok.com"
    ];

    const interceptRequests = () => {
        const origOpen = XMLHttpRequest.prototype.open;
        XMLHttpRequest.prototype.open = function(method, url) {
            if (blockedDomains.some(d => url.includes(d))) {
                console.log("Blocked XHR:", url);
                return; // abort request
            }
            return origOpen.apply(this, arguments);
        };
    };
    interceptRequests();

    // ============================
    // 2️⃣ Cosmetic / layout cleanup
    // ============================
    const style = document.createElement('style');
    style.innerHTML = `
        * { animation: none !important; transition: none !important; }
        html, body { overflow: auto !important; }
    `;
    document.documentElement.appendChild(style);

    // ============================
    // 3️⃣ Static ad container removal (pre-render)
    // ============================
    const staticSelectors = [
        '[class*="ad"]','[id*="ad"]','[class*="ads"]','[id*="ads"]',
        '[class*="banner"]','[class*="promo"]','[class*="sponsor"]',
        '[class*="commercial"]','[class*="marketing"]',
        'iframe','aside','footer',
        'div:empty','section:empty','article:empty'
    ];

    const removeStaticElements = () => {
        staticSelectors.forEach(sel => {
            document.querySelectorAll(sel).forEach(el => el.remove());
        });
    };
    removeStaticElements();
    const observerStatic = new MutationObserver(removeStaticElements);
    observerStatic.observe(document.documentElement, { childList: true, subtree: true });

    // ============================
    // 4️⃣ Ollama AI dynamic detection
    // ============================
    const ollamaBlock = async (el) => {
        if (!el.innerText || el.innerText.length < 20) return;
        try {
            const response = await fetch('http://localhost:11434/v1/ollama', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    model: 'llama2',
                    prompt: `Is the following content an advertisement, sponsored post, or promotional material? Answer "yes" or "no":\n${el.innerText}`
                })
            });
            const data = await response.json();
            if (data.output_text.toLowerCase().includes('yes')) {
                el.remove();
            }
        } catch (e) {
            console.error('Ollama AI block error:', e);
        }
    };

    const dynamicSelectors = ['article','div','section','aside'];
    const runOllamaAI = () => {
        dynamicSelectors.forEach(sel => {
            document.querySelectorAll(sel).forEach(el => ollamaBlock(el));
        });
    };

    document.addEventListener('DOMContentLoaded', runOllamaAI);
    const observerDynamic = new MutationObserver(runOllamaAI);
    observerDynamic.observe(document.documentElement, { childList: true, subtree: true });

})();
